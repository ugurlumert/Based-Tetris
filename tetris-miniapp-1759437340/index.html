<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TetriTiny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1b2d" />
  <meta name="color-scheme" content="dark" />

  <!-- Social -->
  <meta property="og:title" content="TetriTiny â€” Onchain Tetris" />
  <meta property="og:description" content="Play Tetris, earn XP on Base, and see your personal rank." />
  <meta property="og:image" content="/cover.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="/cover.png" />

  <!-- Farcaster Mini App -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"/cover.png","button":{"title":"Open TetriTiny"}}' />

  <link rel="icon" href="/icon.png" />
  <link rel="apple-touch-icon" href="/icon.png" />

  <style>
    :root{ --card-w:clamp(320px,86vw,560px) }
    html,body{ background:#0f1b2d; color:#e6fbff; margin:0 }
    .banner{ padding:10px 12px; text-align:center; background:#12223d; border-bottom:1px solid #2b3e69; font-weight:700 }
    .version{ font-size:12px; opacity:.65; margin-left:8px }

    .container{ max-width:var(--card-w); margin:14px auto 88px; display:grid; gap:14px; padding:0 10px }
    .card{ position:relative; background:#0d1626; border:1px solid #233452; border-radius:14px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,.25) }

    #tetris{ display:block; width:100%; height:auto; border-radius:10px; background:#091426; touch-action:none; outline:none }

    .lock{ position:absolute; inset:14px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;
           border-radius:10px; background:rgba(10,16,28,.82); backdrop-filter:blur(3px); text-align:center; padding:16px; z-index:3 }

    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    button{ appearance:none; border:none; border-radius:10px; padding:10px 14px; background:#1b2a45; color:#e6fbff; font-weight:600;
            box-shadow:inset 0 0 0 1px #2b3e69; cursor:pointer; touch-action:manipulation }
    button:hover{ background:#20355a } button[disabled]{ opacity:.6; cursor:not-allowed }

    .mobile-controls{ position:fixed; left:0; right:0; bottom:0; padding:max(8px,env(safe-area-inset-bottom)) 12px 12px;
      background:linear-gradient(180deg,rgba(10,16,28,0),rgba(10,16,28,.85) 30%,rgba(10,16,28,.95));
      border-top:1px solid #233452; backdrop-filter:blur(6px); display:none; z-index:4 }
    .mobile-controls .grid{ max-width:var(--card-w); margin:0 auto; display:grid; grid-template-columns:repeat(5,1fr); gap:10px }
    .ctrl{ border:1px solid #2b3e69; border-radius:14px; padding:12px; text-align:center; background:#0d1626; font-size:18px; font-weight:800; user-select:none }
    .ctrl:active{ transform:translateY(1px) }
    .ctrl.small{ font-size:16px }

    @media (pointer:coarse){ .mobile-controls{ display:block } }

    .me{ font-weight:700; color:#00ffcc }
  </style>

  <!-- Farcaster SDK (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@farcaster/mini-apps-sdk@latest/dist/browser/mini-apps-sdk.umd.js"></script>
</head>
<body>
  <div class="banner" id="topBanner">Connect wallet to play <span class="version">BUILD: 2025-10-05-touchfix</span></div>

  <div class="container">
    <div class="card">
      <canvas id="tetris" width="240" height="400" tabindex="0" aria-label="TetriTiny"></canvas>
      <div id="lock" class="lock" aria-live="polite">
        <h3>Connect wallet to play</h3>
        <p>Your XP will be recorded on Base.</p>
        <div class="row">
          <button id="connectBtn">ðŸ”— Connect Wallet</button>
          <button id="otherWalletsBtn" title="Open with MetaMask or Coinbase">Other walletsâ€¦</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h1 style="margin:6px 0 10px">TetriTiny</h1>
      <div class="row" style="margin-top:2px">
        <button id="startButton" disabled>Start</button>
        <button id="finishButton" disabled>Finish</button>
      </div>

      <div class="stats">
        <p>Address: <span id="addr">Not connected</span></p>
        <p>XP: <span id="xp">0</span></p>
        <p>Score: <span id="score">0</span></p>
        <p>Lines: <span id="lines">0</span></p>
        <p>Level: <span id="level">1</span></p>
      </div>

      <h2>Your Rank</h2>
      <ul id="leaderboard"></ul>
    </div>
  </div>

  <div class="mobile-controls" id="mobileControls">
    <div class="grid">
      <div class="ctrl" data-key="ArrowLeft">â—€</div>
      <div class="ctrl" data-key="ArrowRight">â–¶</div>
      <div class="ctrl" data-key="ArrowUp" title="Rotate">âŸ³</div>
      <div class="ctrl" data-key="ArrowDown" title="Soft drop">â¬‡</div>
      <div class="ctrl small" data-key="Space" title="Hard drop">â¬‡â¬‡</div>
    </div>
  </div>

  <!-- Game -->
  <script src="tetris.js"></script>
  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
  (async function(){
    /* ---------- Farcaster ready() ---------- */
    async function fcReady(){
      try{
        const a = window?.FarcasterMiniAppsSDK?.actions || window?.farcaster?.actions || window?.warpcast?.actions || window?.sdk?.actions;
        if (a?.ready) { await a.ready(); return; }
        const { sdk } = await import('https://esm.sh/@farcaster/miniapp-sdk');
        await sdk.actions.ready();
      }catch(_){ try{ window.parent?.postMessage?.({type:'miniapp:ready'},'*'); }catch(__){} }
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fcReady, {once:true}); else fcReady();
    window.addEventListener('load', fcReady, {once:true});

    /* ---------- Chain / Contract ---------- */
    const CONTRACT_ADDRESS = "0x1F268942987EE88397e6263b3Eff23a2840F31AD";
    const DEPLOY_BLOCK     = 36327995;
    const BASE_PARAMS = {
      chainId:'0x2105', chainName:'Base Mainnet',
      nativeCurrency:{name:'Ether',symbol:'ETH',decimals:18},
      rpcUrls:['https://base.llamarpc.com'],
      blockExplorerUrls:['https://basescan.org/']
    };
    const ABI = [
      "event XpRecorded(address indexed player,uint256 amount,uint256 newTotal,bytes32 sessionId)",
      "function record(uint256 amount,bytes32 sessionId) external",
      "function totalXp(address) view returns (uint256)"
    ];

    /* ---------- DOM ---------- */
    const $canvas = document.getElementById('tetris');
    const $banner = document.getElementById('topBanner');
    const $addr   = document.getElementById('addr');
    const $lock   = document.getElementById('lock');
    const $start  = document.getElementById('startButton');
    const $finish = document.getElementById('finishButton');

    /* ---------- State ---------- */
    let currentAddress = null; // lowercased
    let xp = 0, sessionXp = 0;
    let connected = false;

    window.addEventListener('keydown', (e)=>{
      if (['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault();
    }, { passive:false });

    /* ---------- Wallet helpers ---------- */
    async function ensureBaseNetwork(provider){
      const chainId = await provider.send('eth_chainId', []);
      if (chainId !== BASE_PARAMS.chainId) {
        try{ await provider.send('wallet_switchEthereumChain', [{ chainId: BASE_PARAMS.chainId }]); }
        catch(e){
          if (e.code === 4902 || String(e.message||'').includes('Unrecognized chain ID')){
            await provider.send('wallet_addEthereumChain', [BASE_PARAMS]);
          } else { throw e; }
        }
      }
    }
    async function connectInjected(){
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      await ensureBaseNetwork(provider);
      const signer = provider.getSigner();
      currentAddress = (await signer.getAddress()).toLowerCase();
      $addr.textContent = currentAddress.slice(0,6)+"..."+currentAddress.slice(-4);
      afterConnected();
    }

    /* ---- Robust Deep Links ---- */
    function cleanDappHost(){ return location.href.replace(/^https?:\/\//,''); }
    function openMetaMask(){
      const host  = cleanDappHost();
      const uni   = `https://metamask.app.link/dapp/${host}`;
      const sch   = `metamask://dapp/${host}`;
      let opened=false; try{ const w=window.open(uni,'_blank'); if(w) opened=true; }catch(_){}
      if(!opened) location.href=uni;
      setTimeout(()=>{ try{ location.href=sch; }catch(_){} },1200);
      setTimeout(async ()=>{ try{ await navigator.clipboard.writeText(uni); alert('If MetaMask didnâ€™t open, paste this:\n'+uni); }catch(_){} },2400);
    }
    function openCoinbase(){
      const url=encodeURIComponent(location.href);
      const uni=`https://go.cb-w.com/dapp?cb_url=${url}`;
      let opened=false; try{ const w=window.open(uni,'_blank'); if(w) opened=true; }catch(_){}
      if(!opened) location.href=uni;
    }

    document.getElementById('connectBtn').addEventListener('click', async ()=>{
      try{
        if (window.ethereum) await connectInjected();
        else if (confirm('Open in MetaMask? Cancel = Coinbase')) openMetaMask(); else openCoinbase();
      }catch(e){ alert(e?.message || 'Wallet connection failed'); }
    });
    document.getElementById('otherWalletsBtn').addEventListener('click', ()=>{
      if (confirm('Open in MetaMask? Cancel = Coinbase')) openMetaMask(); else openCoinbase();
    });

    if (window.ethereum){
      window.ethereum.on?.('accountsChanged', async (acc)=>{ if(acc?.length){ await connectInjected().catch(console.error) } });
      window.ethereum.on?.('chainChanged',   async ()=>{ if(connected){ await connectInjected().catch(console.error) } });
    }

    /* ---------- XP (local) ---------- */
    function loadXPFromStorage(){
      if (!currentAddress) return;
      const saved = localStorage.getItem("xp_" + currentAddress);
      xp = saved ? parseInt(saved,10) : 0;
      const el = document.getElementById("xp"); if (el) el.textContent = xp;
    }
    function addXP(amount){
      sessionXp += amount;
      xp += amount;
      if (currentAddress) localStorage.setItem("xp_" + currentAddress, String(xp));
      const el = document.getElementById("xp"); if (el) el.textContent = xp;
    }

    /* ---------- On-chain XP (throttle + retry) ---------- */
    let _flushing=false, _lastFlush=0, _queued=false;
    async function flushXP(){
      if (!currentAddress || sessionXp <= 0) return;

      const now = Date.now();
      if (now - _lastFlush < 15000) {
        if (!_queued) { _queued = true; setTimeout(()=>{ _queued=false; flushXP(); }, 16000 - (now - _lastFlush)); }
        return;
      }
      if (_flushing) { _queued = true; return; }

      _flushing = true;
      try{
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await ensureBaseNetwork(provider);
        const signer   = provider.getSigner();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        const sessionId = ethers.utils.hexlify(ethers.utils.randomBytes(32));

        const tx = await contract.record(ethers.BigNumber.from(sessionXp), sessionId);
        await tx.wait();
        sessionXp = 0;
        await fetchAndRenderMyRank();
      }catch(e){
        const msg = (e?.data?.message || e?.message || '').toString();
        if (/rate limit|rate limited|limited/i.test(msg)) {
          setTimeout(()=>{ _flushing=false; flushXP(); }, 17000);
          return;
        }
        alert("XP save failed: " + msg);
      }finally{
        _lastFlush = Date.now();
        _flushing  = false;
        if (_queued) { _queued = false; flushXP(); }
      }
    }

    /* ---------- Rank ---------- */
    async function getFarcasterHandle(addr){
      try{
        const resp = await fetch(`https://api.neynar.com/v2/farcaster/user-by-verification?address=${addr}`, {
          headers: { "accept":"application/json", "api_key":"NEYNAR_ANON_API_KEY" }
        });
        if (!resp.ok) throw 0;
        const data = await resp.json();
        if (data?.result?.user?.username) return "@"+data.result.user.username;
      }catch(_){ }
      return null;
    }
    async function fetchAndRenderMyRank(){
      const banner = document.getElementById("topBanner");
      const ul = document.getElementById("leaderboard");
      banner.textContent = connected ? "Loading your rankâ€¦" : "Connect wallet to play";
      if (!connected){ ul && (ul.innerHTML=""); return; }

      try{
        const provider = new ethers.providers.JsonRpcProvider("https://base.llamarpc.com");
        const contract  = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
        const tip = await provider.getBlockNumber();

        const players = new Set();
        try{
          const events = await contract.queryFilter("XpRecorded", DEPLOY_BLOCK, tip);
          events.forEach(ev => players.add(ev.args.player.toLowerCase()));
        }catch(_){}

        players.add(currentAddress);

        const all=[];
        for (const addr of players){
          try{
            const xpVal = await contract.totalXp(addr);
            const xpNum = (()=>{ try { return xpVal.toNumber(); } catch(_) { return Number(xpVal.toString()); }})();
            all.push({ address: addr, xp: xpNum });
          }catch(_){ all.push({ address: addr, xp: 0 }); }
        }
        all.sort((a,b)=>b.xp-a.xp);
        const idx = all.findIndex(x=>x.address===currentAddress);
        const myXp = idx>=0 ? all[idx].xp : 0;

        const handle = await getFarcasterHandle(currentAddress);
        const name = handle || (currentAddress.slice(0,6)+"..."+currentAddress.slice(-4));
        banner.textContent = `Youâ€™re #${idx+1} â€” ${myXp} XP ${handle?('('+handle+')'):''}`;

        if (ul){ ul.innerHTML=""; const li=document.createElement("li"); li.className="me"; li.textContent=`#${idx+1} ${name} â€” ${myXp} XP (You)`; ul.appendChild(li); }
      }catch(_){
        const short=currentAddress?currentAddress.slice(0,6)+"..."+currentAddress.slice(-4):"you";
        banner.textContent=`You â€” 0 XP (${short})`;
      }
    }
    window.addEventListener('load', fetchAndRenderMyRank);

    /* ---------- Touch gestures (tek dispatch) ---------- */
    (function(){
      const el=$canvas, TAP_MS=250, TAP_PX=12, STEP=28; // STEP biraz bÃ¼yÃ¼tÃ¼ldÃ¼ (Ã§ift adÄ±m Ã¶nleme)
      let sx=0,sy=0,lx=0,ly=0,t0=0,moved=false;

      function synth(key){
        const keyCodeMap = {ArrowLeft:37, ArrowUp:38, ArrowRight:39, ArrowDown:40, Space:32};
        const ev = new KeyboardEvent('keydown', { key, code:key, bubbles:true, cancelable:true });
        try { Object.defineProperty(ev, 'keyCode', { get: () => keyCodeMap[key] || 0 }); } catch(_) {}
        document.dispatchEvent(ev);          // << SADECE BÄ°R YERE
      }

      function start(e){const p=(e.touches?e.touches[0]:e); sx=lx=p.clientX; sy=ly=p.clientY; t0=performance.now(); moved=false}
      function move(e){
        const p=(e.touches?e.touches[0]:e), dx=p.clientX-lx, dy=p.clientY-ly;
        const stepsX=Math.trunc(dx/STEP); if(stepsX){ for(let i=0;i<Math.abs(stepsX);i++) synth(stepsX>0?'ArrowRight':'ArrowLeft'); lx+=stepsX*STEP; moved=true }
        const stepsD=Math.trunc((p.clientY-ly)/STEP); if(stepsD>0){ for(let i=0;i<stepsD;i++) synth('ArrowDown'); ly+=stepsD*STEP; moved=true }
        e.preventDefault();
      }
      function end(){const dt=performance.now()-t0, dx=Math.abs(lx-sx), dy=Math.abs(ly-sy); if(!moved&&dt<=TAP_MS&&dx<=TAP_PX&&dy<=TAP_PX) synth('ArrowUp')}

      // Pointer varsa onu kullan; yoksa Touch kullan â†’ Ã‡Ä°FT TETÄ°KLEME YOK
      if (window.PointerEvent){
        const opts={passive:false};
        el.addEventListener('pointerdown',start,opts);
        el.addEventListener('pointermove', move, opts);
        el.addEventListener('pointerup',   end,  opts);
      }else{
        const opts={passive:false};
        el.addEventListener('touchstart',start,opts);
        el.addEventListener('touchmove', move, opts);
        el.addEventListener('touchend',  end,  opts);
      }
    })();

    /* ---------- Ekran Ã¼stÃ¼ mobil butonlar (tek dispatch + stopPropagation) ---------- */
    (function(){
      const bar=document.getElementById('mobileControls');
      const isTouch = ()=> (navigator.maxTouchPoints>0) || window.matchMedia('(pointer:coarse)').matches;
      if(!isTouch()) return; bar.style.display='block';

      function synth(key){
        const keyCodeMap = {ArrowLeft:37, ArrowUp:38, ArrowRight:39, ArrowDown:40, Space:32};
        const ev = new KeyboardEvent('keydown', { key, code:key, bubbles:true, cancelable:true });
        try { Object.defineProperty(ev, 'keyCode', { get: () => keyCodeMap[key] || 0 }); } catch(_) {}
        document.dispatchEvent(ev);          // << SADECE document
      }
      const repeatable=new Set(['ArrowLeft','ArrowRight','ArrowDown']);
      const timers=new Map();
      function startR(key,el){ synth(key); if(!repeatable.has(key))return;
        const t1=setTimeout(()=>{ const t2=setInterval(()=>synth(key),70); timers.set(el,t2); },220);
        timers.set(el,t1);
      }
      function stopR(el){ const t=timers.get(el); if(!t)return; clearTimeout(t); clearInterval(t); timers.delete(el); }

      bar.querySelectorAll('.ctrl').forEach(btn=>{
        const key=btn.getAttribute('data-key');
        btn.addEventListener('pointerdown',e=>{ e.preventDefault(); e.stopPropagation(); startR(key,btn); });
        ['pointerup','pointercancel','pointerleave'].forEach(ev=> btn.addEventListener(ev,()=>stopR(btn)));
        btn.addEventListener('click',e=>e.preventDefault());
      });
    })();

    /* ---------- Responsive width ---------- */
    (function fitCard(){
      function fit(){
        const reserved = 280, vh = window.innerHeight, vw = window.innerWidth;
        const maxByHeight = Math.max(320, Math.floor((vh - reserved) * 0.60));
        const maxByWidth  = Math.floor(vw * 0.90);
        const w = Math.max(320, Math.min(560, maxByHeight, maxByWidth));
        document.documentElement.style.setProperty('--card-w', w + 'px');
      }
      window.addEventListener('resize', fit);
      window.addEventListener('orientationchange', fit);
      fit();
    })();

    /* ---------- Connected ---------- */
    function afterConnected(){
      connected = true;
      loadXPFromStorage();
      fetchAndRenderMyRank().catch(console.error);
      $lock.style.display='none';
      $banner.textContent='Connected â€” press Start!';
      $start.disabled=false;
      $finish.disabled=false;
      try{ $canvas.focus(); }catch(_){}
    }

    /* ---------- Bridge to tetris.js ---------- */
    window.__miniapp = {
      addXP: (n)=>{ sessionXp += n; xp += n; if(currentAddress) localStorage.setItem("xp_" + currentAddress, String(xp));
                    const el=document.getElementById("xp"); if(el) el.textContent=xp; },
      flushXP: ()=>{}, // tetris Ã§aÄŸÄ±rmÄ±yor; tek yer: onGameOver
      onGameOver: ()=>{ flushXP(); }
    };

    /* ---------- Auto unlock ---------- */
    (async function autoUnlock(){
      try{
        if(!window.ethereum) return;
        const provider=new ethers.providers.Web3Provider(window.ethereum);
        const acc=await provider.listAccounts();
        if(acc && acc.length) await connectInjected();
      }catch(_){}
    })();

  })();
  </script>
</body>
</html>
