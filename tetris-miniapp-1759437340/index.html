<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TetriTiny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1b2d" />
  <meta name="color-scheme" content="dark" />

  <!-- Social -->
  <meta property="og:title" content="TetriTiny ‚Äî Onchain Tetris" />
  <meta property="og:description" content="Play Tetris, earn XP on Base, and see your personal rank." />
  <meta property="og:image" content="/cover.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="/cover.png" />

  <!-- Farcaster button (optional) -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"/cover.png","button":{"title":"Open TetriTiny"}}' />

  <link rel="icon" href="/icon.png" />
  <link rel="apple-touch-icon" href="/icon.png" />

  <style>
    :root{--card-w:clamp(320px,86vw,560px)}
    html,body{background:#0f1b2d;color:#e6fbff;margin:0}
    .banner{padding:10px 12px;text-align:center;background:#12223d;border-bottom:1px solid #2b3e69;font-weight:700}
    .version{font-size:12px;opacity:.7;margin-left:8px}
    .container{max-width:var(--card-w);margin:14px auto 88px;display:grid;gap:14px;padding:0 10px}
    .card{position:relative;background:#0d1626;border:1px solid #233452;border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    #tetris{display:block;width:100%;height:auto;border-radius:10px;background:#091426;touch-action:none}
    .lock{position:absolute;inset:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;border-radius:10px;background:rgba(10,16,28,.82);backdrop-filter:blur(3px);text-align:center;padding:16px;z-index:3}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:none;border-radius:10px;padding:10px 14px;background:#1b2a45;color:#e6fbff;font-weight:600;box-shadow:inset 0 0 0 1px #2b3e69;cursor:pointer;touch-action:manipulation}
    button:hover{background:#20355a}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .timer{margin-left:auto;padding:8px 12px;border-radius:999px;background:#172746;border:1px solid #2b3e69;font-weight:700;min-width:88px;text-align:center}
    .timer.warn{background:#2a1e1e;border-color:#6b2b2b}
    .mobile-controls{position:fixed;left:0;right:0;bottom:0;padding:max(8px,env(safe-area-inset-bottom)) 12px 12px;background:linear-gradient(180deg,rgba(10,16,28,0),rgba(10,16,28,.85) 30%,rgba(10,16,28,.95));border-top:1px solid #233452;backdrop-filter:blur(6px);display:none;z-index:4}
    .mobile-controls .grid{max-width:var(--card-w);margin:0 auto;display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .ctrl{border:1px solid #2b3e69;border-radius:14px;padding:12px;text-align:center;background:#0d1626;font-size:18px;font-weight:800;user-select:none}
    .ctrl:active{transform:translateY(1px)}.ctrl.small{font-size:16px}
    @media (pointer:coarse){ .mobile-controls{display:block} }
    .modal{position:fixed;inset:0;display:none;z-index:10}
    .modal .sheet{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#0d1626;border:1px solid #233452;border-radius:16px;padding:16px;max-width:92vw}
    .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
  </style>
</head>
<body>
  <div class="banner" id="topBanner">Connect wallet to play <span class="version">BUILD: PROBE-108</span></div>

  <div class="container">
    <div class="card">
      <canvas id="tetris" width="240" height="400" aria-label="TetriTiny"></canvas>

      <!-- Lock overlay -->
      <div id="lock" class="lock">
        <h3>Connect wallet to play</h3>
        <p>Your XP will be recorded on Base.</p>
        <div class="row">
          <button id="connectBtn">üîó Connect Wallet</button>
          <button id="otherWalletsBtn">Other wallets‚Ä¶</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h1 style="margin:6px 0 10px">TetriTiny</h1>
      <div class="row" style="margin-top:2px">
        <button id="startButton" disabled>Start</button>
        <button id="finishButton" disabled>Finish</button>
        <div id="countdown" class="timer" aria-live="polite">‚è± 01:00</div>
      </div>

      <div class="stats">
        <p>Address: <span id="addr">Not connected</span></p>
        <p>XP: <span id="xp">0</span></p>
        <p>Score: <span id="score">0</span></p>
        <p>Lines: <span id="lines">0</span></p>
        <p>Level: <span id="level">1</span></p>
      </div>

      <h2>Your Rank</h2>
      <ul id="leaderboard"></ul>
    </div>
  </div>

  <!-- Mobile touch bar -->
  <div class="mobile-controls" id="mobileControls">
    <div class="grid">
      <div class="ctrl" data-key="ArrowLeft">‚óÄ</div>
      <div class="ctrl" data-key="ArrowRight">‚ñ∂</div>
      <div class="ctrl" data-key="ArrowUp" title="Rotate">‚ü≥</div>
      <div class="ctrl" data-key="ArrowDown" title="Soft drop">‚¨á</div>
      <div class="ctrl small" data-key="Space" title="Hard drop">‚¨á‚¨á</div>
    </div>
  </div>

  <!-- Wallet modal -->
  <div id="walletModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="wmTitle">
    <div class="sheet">
      <h4 id="wmTitle" style="margin:0 0 8px">Open in a wallet</h4>
      <p style="margin-top:0">No wallet in this browser. Open this page in your wallet‚Äôs dApp browser:</p>
      <div class="row" style="margin-top:6px">
        <button id="openMM">Open in MetaMask</button>
        <button id="openCB">Open in Coinbase</button>
      </div>
      <div class="row" style="margin-top:6px"><button id="closeWM">Close</button></div>
    </div>
    <div class="backdrop"></div>
  </div>

  <!-- Game & Ethers -->
  <script src="tetris.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
  (function(){
    const CONTRACT_ADDRESS="0x1F268942987EE88397e6263b3Eff23a2840F31AD";
    const DEPLOY_BLOCK=36327995;
    const BASE_PARAMS={chainId:'0x2105',chainName:'Base Mainnet',nativeCurrency:{name:'Ether',symbol:'ETH',decimals:18},rpcUrls:['https://base.llamarpc.com'],blockExplorerUrls:['https://basescan.org/']};
    const ABI=["event XpRecorded(address indexed player,uint256 amount,uint256 newTotal,bytes32 sessionId)","function record(uint256 amount,bytes32 sessionId) external","function totalXp(address) view returns (uint256)"];

    // --- DOM
    const $addr=document.getElementById('addr'), $lock=document.getElementById('lock'), $banner=document.getElementById('topBanner');
    const $start=document.getElementById('startButton'), $finish=document.getElementById('finishButton'), $timer=document.getElementById('countdown');
    const $canvas=document.getElementById('tetris');
    const $modal=document.getElementById('walletModal');

    // --- state
    let currentAddress=null, connected=false, xp=0, sessionXp=0;
    let gameRunning=false; // << klavye bloklarƒ±nƒ± bununla y√∂netiyoruz

    // helpers
    const isTouch=()=> (navigator.maxTouchPoints>0) || window.matchMedia('(pointer:coarse)').matches;
    function synth(key){
      const map={ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,Space:32};
      const ev=new KeyboardEvent('keydown',{key,code:key,bubbles:true,cancelable:true});
      try{Object.defineProperty(ev,'keyCode',{get:()=>map[key]||0})}catch(_){}
      window.dispatchEvent(ev); document.dispatchEvent(ev);
    }
    function vibrate(ms){ try{navigator.vibrate?.(ms)}catch(_){} }
    function focusCanvas(){ try{$canvas?.focus()}catch(_){} }

    // Global scroll engelleme YOK; sadece oyun sƒ±rasƒ±nda engelle
    window.addEventListener('keydown', e=>{
      if(!gameRunning) return;
      if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault();
    }, {passive:false});

    // --- Wallet connect
    async function ensureBase(provider){
      const id=await provider.send('eth_chainId',[]);
      if(id!==BASE_PARAMS.chainId){
        try{ await provider.send('wallet_switchEthereumChain',[{chainId:BASE_PARAMS.chainId}]) }
        catch(e){ if(e.code===4902||String(e.message||'').includes('Unrecognized chain ID')){ await provider.send('wallet_addEthereumChain',[BASE_PARAMS]) } else { throw e } }
      }
    }
    async function connectInjected(){
      const provider=new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts',[]);
      await ensureBase(provider);
      const signer=provider.getSigner();
      currentAddress=(await signer.getAddress()).toLowerCase();
      $addr.textContent=currentAddress.slice(0,6)+'...'+currentAddress.slice(-4);
      connected=true; afterConnected();
    }
    function openMetaMask(){ const url=encodeURIComponent(location.href); location.href=`https://link.metamask.io/dapp/${decodeURIComponent(url)}` }
    function openCoinbase(){ const url=encodeURIComponent(location.href); location.href=`https://go.cb-w.com/dapp?cb_url=${url}` }
    function showWM(){ $modal.style.display='block' } function hideWM(){ $modal.style.display='none' }

    async function onConnect(){
      try{
        if(window.ethereum){ await connectInjected() }
        else { showWM() }
      }catch(e){ console.error(e); alert(e?.message||'Wallet connection failed') }
    }
    document.getElementById('connectBtn').addEventListener('click', onConnect);
    document.getElementById('otherWalletsBtn').addEventListener('click', showWM);
    document.getElementById('openMM').addEventListener('click', ()=>{ hideWM(); openMetaMask() });
    document.getElementById('openCB').addEventListener('click', ()=>{ hideWM(); openCoinbase() });
    document.getElementById('closeWM').addEventListener('click', hideWM);
    $modal.querySelector('.backdrop').addEventListener('click', hideWM);

    if(window.ethereum){
      window.ethereum.on?.('accountsChanged',()=>{ if(connected) connectInjected().catch(console.error) });
      window.ethereum.on?.('chainChanged',()=>{ if(connected) connectInjected().catch(console.error) });
    }

    // XP local + chain
    function loadXP(){ if(!currentAddress) return; const s=localStorage.getItem('xp_'+currentAddress); xp=s?parseInt(s,10):0; document.getElementById('xp').textContent=xp }
    function addXP(a){ sessionXp+=a; xp+=a; if(currentAddress){ localStorage.setItem('xp_'+currentAddress,String(xp)) } document.getElementById('xp').textContent=xp }
    async function flushXP(){
      if(!currentAddress||sessionXp<=0) return;
      const provider=new ethers.providers.Web3Provider(window.ethereum); await ensureBase(provider);
      const signer=provider.getSigner(); const c=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
      const sid=ethers.utils.hexlify(ethers.utils.randomBytes(32));
      try{ const tx=await c.record(ethers.BigNumber.from(sessionXp),sid); await tx.wait(); sessionXp=0; await fetchRank() }
      catch(e){ console.error(e); alert('XP save failed: '+(e?.data?.message||e?.message||e)) }
    }

    async function farcasterHandle(addr){
      try{ const r=await fetch(`https://api.neynar.com/v2/farcaster/user-by-verification?address=${addr}`,{headers:{accept:'application/json',api_key:'NEYNAR_ANON_API_KEY'}}); if(!r.ok) throw 0; const d=await r.json(); return d?.result?.user?.username?('@'+d.result.user.username):null }catch(_){ return null }
    }
    async function fetchRank(){
      const ul=document.getElementById('leaderboard');
      $banner.textContent=connected?'Loading your rank‚Ä¶':'Connect wallet to play';
      if(!connected){ ul&&(ul.innerHTML=''); return }
      try{
        const p=new ethers.providers.JsonRpcProvider('https://base.llamarpc.com');
        const c=new ethers.Contract(CONTRACT_ADDRESS,ABI,p);
        const tip=await p.getBlockNumber();
        const players=new Set();
        try{ const ev=await c.queryFilter('XpRecorded',DEPLOY_BLOCK,tip); ev.forEach(e=>players.add(e.args.player.toLowerCase())) }catch(_){}
        players.add(currentAddress);
        const all=[];
        for(const a of players){ try{ const v=await c.totalXp(a); const n=(()=>{try{return v.toNumber()}catch(_){return Number(v.toString())}})(); all.push({address:a,xp:n}) }catch(_){ all.push({address:a,xp:0}) } }
        all.sort((a,b)=>b.xp-a.xp);
        const idx=all.findIndex(x=>x.address===currentAddress);
        const myXp=idx>=0?all[idx].xp:0;
        const handle=await farcasterHandle(currentAddress);
        const name=handle||(currentAddress.slice(0,6)+'...'+currentAddress.slice(-4));
        $banner.textContent=`You‚Äôre #${idx+1} ‚Äî ${myXp} XP ${handle?('('+handle+')'):''}`;
        if(ul){ ul.innerHTML=''; const li=document.createElement('li'); li.className='me'; li.textContent=`#${idx+1} ${name} ‚Äî ${myXp} XP (You)`; ul.appendChild(li) }
      }catch(_){
        const short=currentAddress?currentAddress.slice(0,6)+'...'+currentAddress.slice(-4):'you';
        $banner.textContent=`You ‚Äî 0 XP (${short})`;
      }
    }
    window.addEventListener('load', fetchRank);

    // Dokunmatik jestler
    (function(){
      const el=$canvas, TAP_MS=250, TAP_PX=12, STEP=24, opts={passive:false};
      let sx=0,sy=0,lx=0,ly=0,t0=0,moved=false;
      function start(e){const p=(e.touches?e.touches[0]:e); sx=lx=p.clientX; sy=ly=p.clientY; t0=performance.now(); moved=false}
      function move(e){const p=(e.touches?e.touches[0]:e), dx=p.clientX-lx, dy=p.clientY-ly;
        const stepsX=Math.trunc(dx/STEP); if(stepsX){ for(let i=0;i<Math.abs(stepsX);i++) synth(stepsX>0?'ArrowRight':'ArrowLeft'); lx+=stepsX*STEP; moved=true }
        const stepsD=Math.trunc((p.clientY-ly)/STEP); if(stepsD>0){ for(let i=0;i<stepsD;i++) synth('ArrowDown'); ly+=stepsD*STEP; moved=true }
        e.preventDefault()
      }
      function end(){const dt=performance.now()-t0, dx=Math.abs(lx-sx), dy=Math.abs(ly-sy); if(!moved&&dt<=TAP_MS&&dx<=TAP_PX&&dy<=TAP_PX) synth('ArrowUp')}
      el.addEventListener('touchstart',start,opts); el.addEventListener('touchmove',move,opts); el.addEventListener('touchend',end,opts);
      el.addEventListener('pointerdown',start,opts); el.addEventListener('pointermove',move,opts); el.addEventListener('pointerup',end,opts);
    })();

    // Ekran altƒ± butonlar
    (function(){
      const bar=document.getElementById('mobileControls'); if(isTouch()) bar.style.display='block';
      const repeatable=new Set(['ArrowLeft','ArrowRight','ArrowDown']); const timers=new Map();
      function startR(key,el){synth(key); if(!repeatable.has(key))return; const t1=setTimeout(()=>{const t2=setInterval(()=>synth(key),70); timers.set(el,t2)},220); timers.set(el,t1)}
      function stopR(el){const t=timers.get(el); if(!t)return; clearTimeout(t); clearInterval(t); timers.delete(el)}
      bar.querySelectorAll('.ctrl').forEach(btn=>{const key=btn.getAttribute('data-key');
        btn.addEventListener('pointerdown',e=>{e.preventDefault();startR(key,btn)}); ['pointerup','pointercancel','pointerleave'].forEach(ev=>btn.addEventListener(ev,()=>stopR(btn)));
        btn.addEventListener('click',e=>e.preventDefault());
      });
    })();

    // Turbo + saya√ß (Start ile ba≈ülar)
    (function(){
      const TURBO={enabled:true,startMs:220,minMs:80,rampEverySec:10,rampStepMs:20,sessionSeconds:60};
      let dropMs=TURBO.startMs,dropTimer=null,rampTimer=null,tickTimer=null,remaining=TURBO.sessionSeconds;

      function fmt(s){const m=String(Math.floor(s/60)).padStart(2,'0'),x=String(s%60).padStart(2,'0');return `${m}:${x}`}
      function render(){ if($timer){ $timer.textContent=`‚è± ${fmt(remaining)}`; $timer.classList.toggle('warn',remaining<=10) } }

      function start(){ if(!connected||gameRunning) return; stop(); gameRunning=true; remaining=TURBO.sessionSeconds; dropMs=TURBO.startMs; render();
        focusCanvas();
        dropTimer=setInterval(()=>synth('ArrowDown'),dropMs);
        rampTimer=setInterval(()=>{ if(dropMs<=TURBO.minMs) return; dropMs=Math.max(TURBO.minMs,dropMs-TURBO.rampStepMs); clearInterval(dropTimer); dropTimer=setInterval(()=>synth('ArrowDown'),dropMs) },TURBO.rampEverySec*1000);
        tickTimer=setInterval(()=>{ remaining--; if(remaining<=10) vibrate(8); render(); if(remaining<=0) end(true) },1000);
        $start.disabled=true; $finish.disabled=false;
      }
      function stop(){ clearInterval(dropTimer); clearInterval(rampTimer); clearInterval(tickTimer); dropTimer=rampTimer=tickTimer=null; gameRunning=false }
      async function end(auto){ if(!gameRunning) return; stop(); try{ await flushXP() }catch(_){}
        if($banner) $banner.textContent=auto?'Round finished ‚Äî XP saved (Time up)':'Round finished ‚Äî XP saved';
        if($timer){ $timer.textContent='‚è± 00:00'; $timer.classList.add('warn') }
        $start.disabled=false; $finish.disabled=true;
      }
      $start.addEventListener('click', ()=>{ if(!connected){ showWM(); return } start() });
      $finish.addEventListener('click', ()=>end(false));

      // PC‚Äôde ‚ÄúStart‚Äôa basmayƒ± unutan‚Äùlar i√ßin: ilk y√∂n tu≈üu oyunu ba≈ülatsƒ±n
      window.addEventListener('keydown', (e)=>{ if(!connected||gameRunning) return;
        if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Space'].includes(e.code)){ start() }
      });

      render();
    })();

    // Baƒülanƒ±nca
    async function afterConnected(){
      loadXP(); fetchRank().catch(console.error);
      $lock.style.display='none';
      $banner.textContent='Connected ‚Äî press Start!';
      $start.disabled=false; $finish.disabled=true;
      focusCanvas();
    }

    // dƒ±≈ü API (tetris.js i√ßin)
    window.__miniapp={ connectWallet:onConnect, addXP, flushXP, fetchAndRenderMyRank:fetchRank };
  })();
  </script>
</body>
</html>