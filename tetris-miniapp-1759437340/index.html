<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>TetriTiny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1b2d" />
  <meta name="color-scheme" content="dark light" />

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="TetriTiny ‚Äî Onchain Tetris" />
  <meta property="og:description" content="C√ºzdanƒ±nƒ± baƒüla, oynarken XP kazan, ki≈üisel sƒ±ralamanƒ± g√∂r." />
  <meta property="og:image" content="https://based-tetris.vercel.app/cover.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://based-tetris.vercel.app/cover.png" />

  <!-- Farcaster Mini App -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://based-tetris.vercel.app/cover-1200x800.png","button":{"title":"Open TetriTiny"}}' />

  <!-- Icons -->
  <link rel="icon" href="/icon.png" />
  <link rel="apple-touch-icon" href="/icon.png" />

  <style>
    :root { --card-w: clamp(320px, 86vw, 480px); }
    html, body { background:#0f1b2d; color:#e6fbff; margin:0; padding:0; }
    .banner{ width:100%; text-align:center; padding:10px 12px; background:#12223d; color:#e6fbff;
      border-bottom:1px solid #2b3e69; font-weight:700; letter-spacing:.2px }
    .version{ font-size:12px; opacity:.7; margin-left:8px; }
    .container{ max-width: var(--card-w); margin: 14px auto 88px; display: grid; gap: 14px; padding: 0 10px; }
    .game-card{ position:relative; background:#0d1626; border:1px solid #233452; border-radius:14px; padding:14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25) }
    #tetris{ display:block; width:100%; height:auto; border-radius:10px; background:#091426; touch-action:none }
    .lock{ position:absolute; inset:14px; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:12px; border-radius:10px; background:rgba(10,16,28,.82); backdrop-filter:blur(3px); text-align:center; padding:16px; z-index:2 }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 10px; align-items:center }
    button{ appearance:none; border:none; border-radius:10px; padding:10px 14px; background:#1b2a45; color:#e6fbff;
      font-weight:600; cursor:pointer; box-shadow: inset 0 0 0 1px #2b3e69; touch-action:manipulation }
    button:hover{ background:#20355a } .btn-ghost{ background:#101b2f }
    .stats p{ margin:4px 0 } ul#leaderboard{ margin:8px 0 0; padding:0 0 0 16px }
    .timer{ margin-left:auto; padding:8px 12px; border-radius:999px; background:#172746; border:1px solid #2b3e69;
      font-weight:700; letter-spacing:.3px; min-width:88px; text-align:center; user-select:none }
    .timer.warn{ background:#2a1e1e; border-color:#6b2b2b }
    .mobile-controls{ position:fixed; left:0; right:0; bottom:0; padding:max(8px,env(safe-area-inset-bottom)) 12px 12px;
      background:linear-gradient(180deg,rgba(10,16,28,0),rgba(10,16,28,.85) 30%,rgba(10,16,28,.95));
      border-top:1px solid #233452; backdrop-filter:blur(6px); display:none; z-index:50 }
    .mobile-controls .grid{ max-width:var(--card-w); margin:0 auto; display:grid; grid-template-columns:repeat(5,1fr); gap:10px }
    .ctrl{ border:1px solid #2b3e69; border-radius:14px; padding:12px; text-align:center; background:#0d1626; font-size:18px; font-weight:800; user-select:none; touch-action:manipulation }
    .ctrl:active{ transform:translateY(1px) } .ctrl.small{ font-size:16px }
    @media (pointer:coarse){ .mobile-controls{ display:block } }
  </style>

  <!-- Farcaster Mini Apps SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@farcaster/mini-apps-sdk@latest/dist/browser/mini-apps-sdk.umd.js"></script>
  <script>
    function fcReady(){
      const c=[window?.FarcasterMiniAppsSDK?.actions,window?.farcaster?.actions,window?.warpcast?.actions,window?.sdk?.actions];
      for(const a of c){try{if(a&&typeof a.ready==='function'){a.ready();break}}catch(_){}}}
    document.addEventListener('DOMContentLoaded',()=>setTimeout(fcReady,0));
    window.addEventListener('keydown',e=>{if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault()},{passive:false});
  </script>
</head>
<body>
  <div id="myRankBanner" class="banner">Connect wallet to play <span class="version">Build v2025.10.05-v4</span></div>

  <div class="container">
    <div class="game-card">
      <canvas id="tetris" width="240" height="400" aria-label="TetriTiny game canvas"></canvas>

      <!-- C√úZDAN Kƒ∞Lƒ∞Dƒ∞ -->
      <div id="lock" class="lock" aria-live="polite">
        <h3>Oynamak i√ßin c√ºzdan baƒüla</h3>
        <p>XP'n Base √ºzerinde kaydedilir.</p>
        <div class="row">
          <button id="connect">üîó Connect Wallet</button>
          <button id="moreWallets" class="btn-ghost">Other wallets‚Ä¶</button>
        </div>
      </div>
    </div>

    <div class="side game-card">
      <h1>TetriTiny</h1>
      <div class="row">
        <!-- ‚úÖ Start geri geldi; baƒülanana kadar disabled -->
        <button id="startButton" disabled>Start</button>
        <button id="finishButton" disabled>Finish</button>
        <div id="countdown" class="timer" aria-live="polite" title="Time Left">‚è± 01:00</div>
      </div>

      <div class="stats">
        <p>Address: <span id="addr">Not connected</span></p>
        <p>XP: <span id="xp">0</span></p>
        <p>Score: <span id="score">0</span></p>
        <p>Lines: <span id="lines">0</span></p>
        <p>Level: <span id="level">1</span></p>
      </div>

      <h2>Your Rank</h2>
      <ul id="leaderboard"></ul>
    </div>
  </div>

  <!-- Mobil kontrol √ßubuƒüu -->
  <div class="mobile-controls" id="mobileControls" aria-label="Touch controls">
    <div class="grid">
      <div class="ctrl" data-key="ArrowLeft">‚óÄ</div>
      <div class="ctrl" data-key="ArrowRight">‚ñ∂</div>
      <div class="ctrl" data-key="ArrowUp" title="Rotate">‚ü≥</div>
      <div class="ctrl" data-key="ArrowDown" title="Soft drop">‚¨á</div>
      <div class="ctrl small" data-key="Space" title="Hard drop">‚¨á‚¨á</div>
    </div>
  </div>

  <!-- Mobil c√ºzdan modalƒ± -->
  <div id="walletModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle" style="display:none">
    <div class="sheet" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0d1626;border:1px solid #233452;border-radius:16px;padding:16px;z-index:60;max-width:92vw">
      <h4 id="walletModalTitle" style="margin:0 0 8px">Open in a wallet</h4>
      <p style="margin-top:0">Mobilde provider yoksa, bu sayfayƒ± c√ºzdanƒ±nƒ±n dApp tarayƒ±cƒ±sƒ±nda a√ß.</p>
      <div class="row"><button id="openMetaMask">Open in MetaMask</button><button id="openCoinbase">Open in Coinbase Wallet</button></div>
      <div class="row"><button id="closeModal" class="btn-ghost">Close</button></div>
    </div>
    <div class="backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:55"></div>
  </div>

  <!-- Oyun dosyan -->
  <script src="tetris.js"></script>

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
  (function(){
    const CONTRACT_ADDRESS="0x1F268942987EE88397e6263b3Eff23a2840F31AD";
    const DEPLOY_BLOCK=36327995;
    const BASE_PARAMS={chainId:'0x2105',chainName:'Base Mainnet',nativeCurrency:{name:'Ether',symbol:'ETH',decimals:18},rpcUrls:['https://base.llamarpc.com'],blockExplorerUrls:['https://basescan.org/']};
    const ABI=["event XpRecorded(address indexed player,uint256 amount,uint256 newTotal,bytes32 sessionId)","function record(uint256 amount,bytes32 sessionId) external","function totalXp(address) view returns (uint256)"];

    let currentAddress=null,xp=0,sessionXp=0,connected=false;
    const $addr=document.getElementById("addr"),$lock=document.getElementById("lock"),$banner=document.getElementById("myRankBanner"),$timer=document.getElementById("countdown");
    const $start=document.getElementById("startButton"),$finish=document.getElementById("finishButton");

    function synthKey(key){
      const ev=new KeyboardEvent('keydown',{key,code:key,bubbles:true}); window.dispatchEvent(ev); document.dispatchEvent(ev);
    }
    function vibrate(ms){try{navigator.vibrate?.(ms)}catch(_){}} function isMobile(){return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)}

    async function ensureBaseNetwork(provider){
      const chainId=await provider.send('eth_chainId',[]);
      if(chainId!==BASE_PARAMS.chainId){
        try{await provider.send('wallet_switchEthereumChain',[{chainId:BASE_PARAMS.chainId}])}
        catch(e){if(e.code===4902||String(e.message||'').includes('Unrecognized chain ID')){await provider.send('wallet_addEthereumChain',[BASE_PARAMS])}else{throw e}}
      }
    }
    async function connectInjected(){
      const provider=new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts",[]); await ensureBaseNetwork(provider);
      const signer=provider.getSigner(); currentAddress=(await signer.getAddress()).toLowerCase();
      $addr.textContent=currentAddress.slice(0,6)+"..."+currentAddress.slice(-4);
      connected=true; afterConnected();
    }
    function openDeepLinkMetaMask(){const u=encodeURIComponent(location.href); location.href=`https://link.metamask.io/dapp/${decodeURIComponent(u)}`}
    function openDeepLinkCoinbase(){const u=encodeURIComponent(location.href); location.href=`https://go.cb-w.com/dapp?cb_url=${u}`}

    async function connectWallet(){
      try{
        if(window.ethereum){ await connectInjected() }
        else if(isMobile()){ showWalletModal() }
        else{ alert("MetaMask / Coinbase Wallet gerekiyor.") }
      }catch(e){ console.error(e); alert(e?.message||"Wallet connection failed") }
    }
    document.getElementById("connect").addEventListener("click",connectWallet);
    document.getElementById("moreWallets").addEventListener("click",showWalletModal);

    if(window.ethereum){
      window.ethereum.on?.('accountsChanged',()=>{ if(connected) connectInjected().catch(console.error) });
      window.ethereum.on?.('chainChanged',()=>{ if(connected) connectInjected().catch(console.error) });
    }

    // Wallet modal
    const $modal=document.getElementById('walletModal');
    function showWalletModal(){ $modal.style.display='block' }
    function hideWalletModal(){ $modal.style.display='none' }
    document.getElementById('openMetaMask').onclick=()=>{ hideWalletModal(); openDeepLinkMetaMask() };
    document.getElementById('openCoinbase').onclick=()=>{ hideWalletModal(); openDeepLinkCoinbase() };
    document.getElementById('closeModal').onclick=hideWalletModal;
    $modal.querySelector('.backdrop').onclick=hideWalletModal;

    // XP
    function loadXPFromStorage(){ if(!currentAddress) return; const saved=localStorage.getItem("xp_"+currentAddress); xp=saved?parseInt(saved,10):0; updateXPUI() }
    function addXP(a){ sessionXp+=a; xp+=a; if(currentAddress){ localStorage.setItem("xp_"+currentAddress,String(xp)) } updateXPUI() }
    function updateXPUI(){ const el=document.getElementById("xp"); if(el) el.textContent=xp }

    // On-chain XP
    async function flushXP(){
      if(!currentAddress||sessionXp<=0) return;
      const provider=new ethers.providers.Web3Provider(window.ethereum); await ensureBaseNetwork(provider);
      const signer=provider.getSigner(); const contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
      const sessionId=ethers.utils.hexlify(ethers.utils.randomBytes(32));
      try{ const tx=await contract.record(ethers.BigNumber.from(sessionXp),sessionId); await tx.wait(); sessionXp=0; await fetchAndRenderMyRank() }
      catch(e){ console.error(e); alert("XP kaydedilemedi: "+(e?.data?.message||e?.message||e)) }
    }

    async function getFarcasterHandle(addr){
      try{ const r=await fetch(`https://api.neynar.com/v2/farcaster/user-by-verification?address=${addr}`,{headers:{"accept":"application/json","api_key":"NEYNAR_ANON_API_KEY"}}); if(!r.ok) throw 0; const d=await r.json(); return d?.result?.user?.username?("@"+d.result.user.username):null }catch(_){ return null }
    }
    async function fetchAndRenderMyRank(){
      const ul=document.getElementById("leaderboard");
      $banner.textContent=connected?"Loading your rank‚Ä¶":"Connect wallet to play";
      if(!connected){ ul&&(ul.innerHTML=""); return }
      try{
        const provider=new ethers.providers.JsonRpcProvider("https://base.llamarpc.com");
        const contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,provider);
        const currentBlock=await provider.getBlockNumber();
        let players=new Set();
        try{ const evs=await contract.queryFilter("XpRecorded",DEPLOY_BLOCK,currentBlock); evs.forEach(ev=>players.add(ev.args.player.toLowerCase())) }catch(_){}
        players.add(currentAddress);
        const all=[]; for(const addr of players){ try{ const v=await contract.totalXp(addr); all.push({address:addr,xp:v.toNumber()}) }catch(_){ all.push({address:addr,xp:0}) } }
        all.sort((a,b)=>b.xp-a.xp); const myIndex=all.findIndex(x=>x.address===currentAddress); const myXp=myIndex>=0?all[myIndex].xp:0;
        const handle=await getFarcasterHandle(currentAddress); const myName=handle||(currentAddress.slice(0,6)+"..."+currentAddress.slice(-4));
        $banner.textContent=`You‚Äôre #${myIndex+1} ‚Äî ${myXp} XP ${handle?("("+handle+")"):""}`;
        if(ul){ ul.innerHTML=""; const li=document.createElement("li"); li.className="me"; li.textContent=`#${myIndex+1} ${myName} ‚Äî ${myXp} XP (You)`; ul.appendChild(li) }
      }catch(_){
        const short=currentAddress?(currentAddress.slice(0,6)+"..."+currentAddress.slice(-4)):"N/A";
        $banner.textContent=connected?`You ‚Äî 0 XP (${short})`:"Connect wallet to play";
      }
    }
    window.addEventListener("load",fetchAndRenderMyRank);

    // Dokunmatik jestler
    (function(){
      const el=document.getElementById('tetris'); const TAP_MS=250,TAP_PX=12,STEP=24; const opts={passive:false};
      let sx=0,sy=0,lx=0,ly=0,start=0,moved=false;
      function onStart(e){const p=(e.touches?e.touches[0]:e); sx=lx=p.clientX; sy=ly=p.clientY; start=performance.now(); moved=false}
      function onMove(e){const p=(e.touches?e.touches[0]:e),dx=p.clientX-lx,dy=p.clientY-ly;
        const stepsX=Math.trunc(dx/STEP); if(stepsX){ for(let i=0;i<Math.abs(stepsX);i++) synthKey(stepsX>0?'ArrowRight':'ArrowLeft'); lx+=stepsX*STEP; moved=true }
        const stepsD=Math.trunc((p.clientY-ly)/STEP); if(stepsD>0){ for(let i=0;i<stepsD;i++) synthKey('ArrowDown'); ly+=stepsD*STEP; moved=true } e.preventDefault()}
      function onEnd(){const dt=performance.now()-start,dx=Math.abs(lx-sx),dy=Math.abs(ly-sy); if(!moved&&dt<=TAP_MS&&dx<=TAP_PX&&dy<=TAP_PX) synthKey('ArrowUp')}
      el.addEventListener('touchstart',onStart,opts); el.addEventListener('touchmove',onMove,opts); el.addEventListener('touchend',onEnd,opts);
      el.addEventListener('pointerdown',onStart,opts); el.addEventListener('pointermove',onMove,opts); el.addEventListener('pointerup',onEnd,opts);
    })();

    // Ekran √ºst√º mobil tu≈ülar
    (function(){
      const bar=document.getElementById('mobileControls'); if(('ontouchstart'in window)||(navigator.maxTouchPoints>0)){ bar.style.display='block' }
      const repeatable=new Set(['ArrowLeft','ArrowRight','ArrowDown']); const timers=new Map();
      function startRepeat(key,el){synthKey(key); if(!repeatable.has(key))return; const t1=setTimeout(()=>{const t2=setInterval(()=>synthKey(key),70); timers.set(el,t2)},220); timers.set(el,t1)}
      function stopRepeat(el){const t=timers.get(el); if(!t)return; clearTimeout(t); clearInterval(t); timers.delete(el)}
      bar.querySelectorAll('.ctrl').forEach(btn=>{const key=btn.getAttribute('data-key');
        btn.addEventListener('pointerdown',e=>{e.preventDefault();startRepeat(key,btn)}); ['pointerup','pointercancel','pointerleave'].forEach(ev=>btn.addEventListener(ev,()=>stopRepeat(btn))); btn.addEventListener('click',e=>e.preventDefault());
      });
    })();

    // Turbo + geri sayƒ±m (ARTIK Start ile ba≈ülƒ±yor)
    (function(){
      const TURBO={enabled:true,startMs:220,minMs:80,rampEverySec:10,rampStepMs:20,sessionSeconds:60};
      let dropMs=TURBO.startMs,dropTimer=null,rampTimer=null,tickTimer=null,remaining=TURBO.sessionSeconds,running=false;

      function fmt(s){const m=String(Math.floor(s/60)).padStart(2,'0'),x=String(s%60).padStart(2,'0');return `${m}:${x}`}
      function render(){ if($timer){ $timer.textContent=`‚è± ${fmt(remaining)}`; $timer.classList.toggle('warn',remaining<=10) } }

      function start(){ if(!TURBO.enabled||running) return; stop(); running=true; remaining=TURBO.sessionSeconds; dropMs=TURBO.startMs; render();
        dropTimer=setInterval(()=>synthKey('ArrowDown'),dropMs);
        rampTimer=setInterval(()=>{ if(dropMs<=TURBO.minMs) return; dropMs=Math.max(TURBO.minMs,dropMs-TURBO.rampStepMs); clearInterval(dropTimer); dropTimer=setInterval(()=>synthKey('ArrowDown'),dropMs) },TURBO.rampEverySec*1000);
        tickTimer=setInterval(()=>{ remaining--; if(remaining<=10) vibrate(8); render(); if(remaining<=0) end(true) },1000);
        if($start) $start.disabled=true; if($finish) $finish.disabled=false;
      }
      function stop(){ clearInterval(dropTimer); clearInterval(rampTimer); clearInterval(tickTimer); dropTimer=rampTimer=tickTimer=null; running=false }
      async function end(auto){ if(!running) return; stop(); try{ await window.__miniapp?.flushXP?.() }catch(_){}
        if($banner) $banner.textContent=auto?'Round finished ‚Äî XP saved (Time up)':'Round finished ‚Äî XP saved';
        if($timer){ $timer.textContent='‚è± 00:00'; $timer.classList.add('warn') } vibrate(30);
        if($start) $start.disabled=false; if($finish) $finish.disabled=true;
      }

      $finish?.addEventListener('click',()=>end(false));
      // Start‚Äôe basƒ±nca turbo ba≈ülasƒ±n (tetris.js kendi start‚Äôƒ±nƒ± zaten dinliyorsa da sorun olmaz)
      $start?.addEventListener('click', ()=>{ if(!connected){ alert('Connect wallet first'); return } start() });

      // Dƒ±≈üarƒ± a√ß
      window.__turbo={start,stop,end,setSeconds:(s)=>{remaining=s;render()}};
      render();
    })();

    // Baƒülanƒ±nca sadece kilidi kaldƒ±r + Start'ƒ± a√ß (artƒ±k auto start YOK)
    async function afterConnected(){
      loadXPFromStorage(); fetchAndRenderMyRank().catch(console.error);
      if($lock) $lock.style.display='none'; if($banner) $banner.textContent='Connected ‚Äî press Start!';
      connected=true; if($start) $start.disabled=false; if($finish) $finish.disabled=true;
    }

    // Mobil c√ºzdan modalƒ± / global
    window.__miniapp={ connectWallet, addXP, flushXP, fetchAndRenderMyRank };
  })();
  </script>
</body>
</html>
